name: "Pipeline: Scrape & Analyze [manual, self-hosted, Docker]"

on:
  workflow_dispatch: # Run manually

permissions:
  pull-requests: write
  contents: read
  statuses: write
  checks: write

jobs:
  test-pipeline-docker:
    runs-on: ubuntu-latest
    environment: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find open PR for branch
        id: pr
        uses: actions/github-script@v6
        with:
          script: |
            const ref = github.ref || context.ref;
            const branch = ref.replace('refs/heads/', '');
            const response = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open',
              'per_page': 1
            });
            const prs = response.data;
            return prs.length > 0 ? {pr_found: 'true', sha: prs[0].head.sha} : {pr_found: 'false', sha: ''}

      - name: Set status to running
        id: set_running
        if: ${{ fromJson(steps.pr.outputs.result).pr_found == 'true' }}
        uses: ./.github/actions/update-pr-status
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sha: ${{ fromJson(steps.pr.outputs.result).sha }}
          context: 'Docker Pipeline Test'
          state: 'pending'
          description: 'Building images and running pipeline...'
          create-check-run: 'true'
          check-run-name: 'Check Pipeline Docker'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.api
          tags: newsbot-pipeline:latest
          push: false
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup Docker Network & Ollama Sidecar
        run: |
          docker network create pipeline-net
          # Start Ollama container
          docker run -d --name ollama-svc --network pipeline-net ollama/ollama
          # Pre-pull the model (adjust model name as needed)
          docker exec ollama-svc ollama pull llama3:8b

      # ===== GEMINI TEST =====
      - name: Run Pipeline (Gemini)
        id: gemini_run
        continue-on-error: true
        run: |
          docker run --rm --name gemini-test \
            --network pipeline-net \
            -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            -e GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
            -e SUPABASE_SERVICE_KEY="${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -e EMAIL_ENABLED="true" \
            -e EMAIL_SMTP_SERVER="${{ vars.EMAIL_SMTP_SERVER }}" \
            -e EMAIL_SMTP_PORT="${{ vars.EMAIL_SMTP_PORT }}" \
            -e EMAIL_USE_SSL="${{ vars.EMAIL_USE_SSL }}" \
            -e EMAIL_SENDER="${{ vars.EMAIL_SENDER }}" \
            -e EMAIL_RECIPIENT="${{ vars.EMAIL_RECIPIENT }}" \
            -e EMAIL_PASSWORD="${{ secrets.EMAIL_PASSWORD }}" \
            newsbot-pipeline:latest \
            bash -c "newsbot run --config test && newsbot analyze --config test --test --email-receivers" | tee gemini_output.log

      - name: Verify Email (Gemini)
        id: email_check_gemini
        if: always()
        run: |
          if grep -q "Email sent successfully" gemini_output.log; then
            echo "✅ Gemini Email Success"
          else
            exit 1
          fi

      # ===== OLLAMA TEST =====
      - name: Run Pipeline (Ollama)
        id: ollama_run
        continue-on-error: true
        run: |
          # Note OLLAMA_HOST points to the container name in the docker network
          docker run --rm --name ollama-test \
            --network pipeline-net \
            -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            -e OLLAMA_HOST="http://ollama-svc:11434" \
            -e SUPABASE_SERVICE_KEY="${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -e EMAIL_ENABLED="true" \
            -e EMAIL_SMTP_SERVER="${{ vars.EMAIL_SMTP_SERVER }}" \
            -e EMAIL_SMTP_PORT="${{ vars.EMAIL_SMTP_PORT }}" \
            -e EMAIL_USE_SSL="${{ vars.EMAIL_USE_SSL }}" \
            -e EMAIL_SENDER="${{ vars.EMAIL_SENDER }}" \
            -e EMAIL_RECIPIENT="${{ vars.EMAIL_RECIPIENT }}" \
            -e EMAIL_PASSWORD="${{ secrets.EMAIL_PASSWORD }}" \
            newsbot-pipeline:latest \
            bash -c "newsbot run --config test_ollama && newsbot analyze --config test_ollama --test --email-receivers" | tee ollama_output.log

      - name: Verify Email (Ollama)
        id: email_check_ollama
        if: always()
        run: |
          if grep -q "Email sent successfully" ollama_output.log; then
            echo "✅ Ollama Email Success"
          else
            exit 1
          fi

      # ===== FINAL STATUS CALCULATION =====
      - name: Calculate final status
        id: calculate_status
        if: always() && fromJson(steps.pr.outputs.result).pr_found == 'true'
        run: |
          GEMINI_OK="${{ steps.gemini_run.outcome == 'success' && steps.email_check_gemini.outcome == 'success' }}"
          OLLAMA_OK="${{ steps.ollama_run.outcome == 'success' && steps.email_check_ollama.outcome == 'success' }}"
          
          if [[ "$GEMINI_OK" == "true" && "$OLLAMA_OK" == "true" ]]; then
            echo "state=success" >> $GITHUB_OUTPUT
            echo "description=Pipeline succeeded (Gemini & Ollama)" >> $GITHUB_OUTPUT
          else
            echo "state=failure" >> $GITHUB_OUTPUT
            echo "description=Pipeline failed. Check logs." >> $GITHUB_OUTPUT
          fi

      - name: Set final PR status
        if: always() && fromJson(steps.pr.outputs.result).pr_found == 'true'
        uses: ./.github/actions/update-pr-status
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sha: ${{ fromJson(steps.pr.outputs.result).sha }}
          context: 'Docker Pipeline Test'
          state: ${{ steps.calculate_status.outputs.state }}
          description: ${{ steps.calculate_status.outputs.description }}
          check-run-id: ${{ steps.set_running.outputs.check-run-id }}
          check-run-name: 'Check Pipeline Docker'

      - name: Cleanup
        if: always()
        run: |
          docker stop ollama-svc || true
          docker network rm pipeline-net || true