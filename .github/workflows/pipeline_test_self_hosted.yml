name: "Pipeline: Scrape & Analyze Test [manual, self-hosted]"
# Runs the news bot pipeline (i.e. newsbot run and newsbot analyze) on 
# a self-hosted runner.
# NOTE: This workflow requires the self-hosted runner to have both 'uv'
# and 'ollama' installed and available in the PATH.

permissions:
  pull-requests: read
  contents: read
  statuses: write
  checks: write

on:
  workflow_dispatch:  # Run manually

jobs:
  test-pipeline:
    runs-on: self-hosted
    environment: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Find open PR for branch
        id: pr
        uses: ./.github/actions/find-pr
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set status to running
        id: set_running
        if: steps.pr.outputs.pr_found == 'true'
        uses: ./.github/actions/update-pr-status
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sha: ${{ steps.pr.outputs.sha }}
          context: 'Test Pipeline (Self-hosted)'
          state: 'pending'
          description: 'Test pipeline is running...'
          create-check-run: 'true'
          check-run-name: 'Check Pipeline'
      
      - name: Install dependencies
        run: uv sync

      # Create the Django database tables (for email notifications)
      - name: Run migrations
        run: uv run ./src/web/manage.py migrate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      # ===== Gemini (Cloud LLM) Test =====
      - name: Run scraper (Gemini)
        id: scraper
        run: uv run newsbot run --config test
        env:
          EMAIL_ENABLED: 'true'
          EMAIL_SMTP_SERVER: ${{ vars.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ vars.EMAIL_SMTP_PORT }}
          EMAIL_USE_SSL: ${{ vars.EMAIL_USE_SSL }}
          EMAIL_SENDER: ${{ vars.EMAIL_SENDER }}
          EMAIL_RECIPIENT: ${{ vars.EMAIL_RECIPIENT }}
          EMAIL_FOR_CANCELLATION: ${{ vars.EMAIL_FOR_CANCELLATION }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Run analysis with test data (Gemini)
        id: analysis
        run: uv run newsbot analyze --config test --test --email-receivers 2>&1 | tee analysis_output.log
        env:
          EMAIL_ENABLED: 'true'
          EMAIL_SMTP_SERVER: ${{ vars.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ vars.EMAIL_SMTP_PORT }}
          EMAIL_USE_SSL: ${{ vars.EMAIL_USE_SSL }}
          EMAIL_SENDER: ${{ vars.EMAIL_SENDER }}
          EMAIL_RECIPIENT: ${{ vars.EMAIL_RECIPIENT }}
          EMAIL_FOR_CANCELLATION: ${{ vars.EMAIL_FOR_CANCELLATION }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      # Verify that the analysis report email was sent
      - name: Verify email was sent (Gemini)
        id: email_check
        if: steps.analysis.outcome == 'success'
        run: |
          if grep -q "Email sent successfully" analysis_output.log; then
            echo "✅ Email was sent successfully (Gemini)"
          else
            echo "❌ Email was NOT sent (Gemini)"
            echo "--- Analysis output ---"
            cat analysis_output.log
            exit 1
          fi

      # ===== Ollama (Local LLM) Test =====
      - name: Run scraper (Ollama)
        id: scraper_ollama
        run: uv run newsbot run --config test_ollama
        env:
          EMAIL_ENABLED: 'true'
          EMAIL_SMTP_SERVER: ${{ vars.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ vars.EMAIL_SMTP_PORT }}
          EMAIL_USE_SSL: ${{ vars.EMAIL_USE_SSL }}
          EMAIL_SENDER: ${{ vars.EMAIL_SENDER }}
          EMAIL_RECIPIENT: ${{ vars.EMAIL_RECIPIENT }}
          EMAIL_FOR_CANCELLATION: ${{ vars.EMAIL_FOR_CANCELLATION }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Run analysis with test data (Ollama)
        id: analysis_ollama
        run: uv run newsbot analyze --config test_ollama --test --email-receivers 2>&1 | tee analysis_output_ollama.log
        env:
          EMAIL_ENABLED: 'true'
          EMAIL_SMTP_SERVER: ${{ vars.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ vars.EMAIL_SMTP_PORT }}
          EMAIL_USE_SSL: ${{ vars.EMAIL_USE_SSL }}
          EMAIL_SENDER: ${{ vars.EMAIL_SENDER }}
          EMAIL_RECIPIENT: ${{ vars.EMAIL_RECIPIENT }}
          EMAIL_FOR_CANCELLATION: ${{ vars.EMAIL_FOR_CANCELLATION }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      # Verify that the Ollama analysis report email was sent
      - name: Verify email was sent (Ollama)
        id: email_check_ollama
        if: steps.analysis_ollama.outcome == 'success'
        run: |
          if grep -q "Email sent successfully" analysis_output_ollama.log; then
            echo "✅ Email was sent successfully (Ollama)"
          else
            echo "❌ Email was NOT sent (Ollama)"
            echo "--- Analysis output ---"
            cat analysis_output_ollama.log
            exit 1
          fi

      # Calculate final status based on all step outcomes
      - name: Calculate final status
        id: calculate_status
        if: always() && steps.pr.outputs.pr_found == 'true'
        run: |
          # Check Gemini outcomes
          GEMINI_PASSED="false"
          if [[ "${{ steps.scraper.outcome }}" == "success" && \
                "${{ steps.analysis.outcome }}" == "success" && \
                "${{ steps.email_check.outcome }}" == "success" ]]; then
            GEMINI_PASSED="true"
          fi

          # Check Ollama outcomes
          OLLAMA_PASSED="false"
          if [[ "${{ steps.scraper_ollama.outcome }}" == "success" && \
                "${{ steps.analysis_ollama.outcome }}" == "success" && \
                "${{ steps.email_check_ollama.outcome }}" == "success" ]]; then
            OLLAMA_PASSED="true"
          fi

          # Determine overall status
          if [[ "$GEMINI_PASSED" == "true" && "$OLLAMA_PASSED" == "true" ]]; then
            echo "state=success" >> $GITHUB_OUTPUT
            echo "description=All tests passed (Gemini + Ollama)" >> $GITHUB_OUTPUT
          else
            echo "state=failure" >> $GITHUB_OUTPUT
            # Build failure message
            FAILED=""
            [[ "${{ steps.scraper.outcome }}" != "success" ]] && FAILED="${FAILED}Scraper (Gemini), "
            [[ "${{ steps.analysis.outcome }}" != "success" ]] && FAILED="${FAILED}Analysis (Gemini), "
            [[ "${{ steps.email_check.outcome }}" != "success" ]] && FAILED="${FAILED}Email (Gemini), "
            [[ "${{ steps.scraper_ollama.outcome }}" != "success" ]] && FAILED="${FAILED}Scraper (Ollama), "
            [[ "${{ steps.analysis_ollama.outcome }}" != "success" ]] && FAILED="${FAILED}Analysis (Ollama), "
            [[ "${{ steps.email_check_ollama.outcome }}" != "success" ]] && FAILED="${FAILED}Email (Ollama), "
            FAILED="${FAILED%, }"  # Remove trailing comma and space
            echo "description=Failed: ${FAILED}" >> $GITHUB_OUTPUT
          fi

      - name: Set final PR status
        if: always() && steps.pr.outputs.pr_found == 'true'
        uses: ./.github/actions/update-pr-status
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sha: ${{ steps.pr.outputs.sha }}
          context: 'Test Pipeline (Self-hosted)'
          state: ${{ steps.calculate_status.outputs.state }}
          description: ${{ steps.calculate_status.outputs.description }}
          check-run-id: ${{ steps.set_running.outputs.check-run-id }}
          check-run-name: 'Check Pipeline'
